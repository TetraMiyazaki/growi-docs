# [Draft] GROWI v6.1.x へのアップグレード


## 目次

[[toc]]


## 管理者向け

### Node.js v14 のサポートを終了

::: tip

- [公式の Docker イメージ](https://hub.docker.com/r/weseek/growi/)を利用しているシステムには影響はありません
:::

1. v16 または v18 にアップグレードしてください

### ビルド手順の変更

::: warning
この項目の内容は、利用者が GitHub で公開されているソースコードから自身でビルドを行っている場合に必要です。  
公式 docker イメージを利用している方は必要ありません。  

:::

ビルドツールとしてこれまで利用してた Lerna に代わって [Turborepo](https://turbo.build/repo) が必要になりました。
また package.json には含まれていないため、グローバルインストールが必要です。
ビルドする前に以下のコマンドでインストールしてください。

1. `yarn global add turbo`

詳しくは [README.md](https://github.com/weseek/growi/blob/master/README_JP.md) および [開発スタートアップ](../../dev/startup-v5/start-development.html) をご覧ください。


### [仕様変更] `FILE_UPLOAD=local` 設定下でのファイル保存場所の変更

::: warning
この項目の内容は、添付ファイルをローカルファイルシステムに保存する設定のシステムでのみ必要です。  
AWS S3 や GCP GCS、MongoDB GridFS に保存しているシステムでは必要有りません。

:::

`app` パッケージの場所が変わったことにより、ファイルの保存場所が変更されました。

| Before | | After |
| :-: | :-: | :-: |
| `/opt/growi/packages/app/public` | -> | `/opt/growi/apps/app/public` |

アップグレード後に既存のファイルを移動させてください。

また以下のディスカッションも参照してください。  
<https://github.com/weseek/growi/discussions/6086>


## 利用者向け

### [仕様変更] アンカーリンクに自動付与される `mdcont-` プレフィクスの廃止

v6.0.0 から、ページ内のあらゆるアンカーリンク(自動生成される目次のリンクも含む)には `mdcont-` というプレフィクスが自動付与されていました。

例:  
`/Sandbox` 内の `Headers` セクションの `id` は `#mdcont-headers` になる。

v6.1.0 以降はこの仕様を廃止し、`mdcont-` プレフィクスが付かないようになりました。

目次等の GROWI が生成するリンクに関してはこれまで同様の利用で特に問題は起こりませんが、
`mdcont-` プレフィクスを含むリンクをドキュメント内に記述していたり、
GROWI 外の文書やシステムから参照している場合はアクセス時にアンカーまでジャンプしない症状が発生します。

該当するリンクは適宜書き換えてください。

::: tip
以前の記法を使って保存されたページの内容は、GROWI 本体をアップグレードしても自動では変更されません。  
マークダウン文書を一括で新しい記法に書き換えるスクリプトを提供していますので、以下のディスカッションを確認してください。  
<https://github.com/weseek/growi/discussions/7180>
:::


## アップグレード前にチェックすべきこと

- [x] Node.js v16 以上を利用しているか
- [x] ソースコードから自身でビルドを行っている場合、新たなビルド手順を確認したか
- [x] `FILE_UPLOAD=local` 設定のシステムで、アップグレード後のファイル移動の手順を確認したか
- [x] アンカーリンクの仕様変更について
  - [x] ユーザーに周知をしたか
  - [x] 既存のページ内容について、今後の書き換えの戦略は決定したか
